name: Build & Deploy to Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - "app/**"
      - "src/**"
      - "pages/**"
      - "components/**"
      - "lib/**"
      - "actions/**"
      - "prisma/**"
      - "Dockerfile"
      - "package.json"
      - "pnpm-lock.yaml"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:
    inputs:
      deployment_message:
        description: 'Deployment message (optional)'
        required: false
        default: 'Manual deployment triggered'
        type: string

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  SERVICE_NAME: ${{ vars.SERVICE_NAME }}
  REPOSITORY: ${{ vars.REPOSITORY }}
  IMAGE: ${{ vars.IMAGE }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -------------------------
      # 1Ô∏è‚É£ Checkout source code
      # -------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------
      # 1.5Ô∏è‚É£ Deployment Info
      # -------------------------
      - name: Display Deployment Info
        run: |
          echo "üöÄ Starting deployment..."
          echo "üìù Commit: ${{ github.event.head_commit.message || inputs.deployment_message }}"
          echo "üë§ Triggered by: ${{ github.actor }}"
          echo "üåø Branch: ${{ github.ref_name }}"

      # -------------------------
      # 2Ô∏è‚É£ Authenticate to GCP
      # -------------------------
      - name: Authenticate to GCP
        run: |
          cat << 'EOF' > key.json
          ${{ secrets.GCP_SA_KEY }}
          EOF

          gcloud auth activate-service-account --key-file=key.json
          gcloud config set project $PROJECT_ID
          gcloud config set run/region $REGION

      # -------------------------
      # 3Ô∏è‚É£ Build & Push Image (Cloud Build)
      # -------------------------
      - name: Run Cloud Build (cloudbuild.yaml)
        run: |
          trim() { echo "$1" | xargs; }
          
          gcloud builds submit . \
            --config=cloudbuild.yaml \
            --substitutions="_REGION=$(trim '${{ env.REGION }}'),_REPOSITORY=$(trim '${{ env.REPOSITORY }}'),_IMAGE=$(trim '${{ env.IMAGE }}'),_NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=$(trim '${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}')" \
            --timeout=900s

      # -------------------------
      # 4Ô∏è‚É£ Deploy to Cloud Run
      # -------------------------
      - name: Deploy to Cloud Run
        run: |
          trim() { echo "$1" | xargs; }
          
          gcloud run deploy $(trim '${{ env.SERVICE_NAME }}') \
            --image $(trim '${{ env.REGION }}')-docker.pkg.dev/$(trim '${{ env.PROJECT_ID }}')/$(trim '${{ env.REPOSITORY }}')/$(trim '${{ env.IMAGE }}'):latest \
            --platform managed \
            --region $(trim '${{ env.REGION }}') \
            --allow-unauthenticated \
            --port 3000 \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 1 \
            --set-env-vars "DATABASE_URL=$(trim '${{ secrets.DATABASE_URL }}'),CLERK_SECRET_KEY=$(trim '${{ secrets.CLERK_SECRET_KEY }}'),GOOGLE_GENERATIVE_AI_API_KEY=$(trim '${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}'),NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=$(trim '${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}')"